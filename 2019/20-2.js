const { prettyPicture } = require('./15-2');

const posId = ([x, y], level = 0) => level*1000000 + x*1000 + y;

const createMap = input => {
    let locations = new Map;
    const jumps = new Map; // posA => posB and posB => posA
    const map = new Map(
            Object.entries(
                input.split('\n')
                    .map(row => new Map(Object.entries(row.split('')).map(([k, v]) => [+k, v])))
                ).map(([k, v]) => [+k, v])
            );

    const getMap = (x, y) => (map.has(y) ? map.get(y) : map.set(y, new Map).get(y)).get(x);
    const setMap = (x, y, value) => (map.has(y) ? map.get(y) : map.set(y, new Map).get(y)).set(x, value);
    const setLocation = (id, pos) => { if (!locations.has(id)) { locations.set(id, []) } locations.get(id).push(pos)};

    const moves = [[[0, 1],  (x, y) => getMap(x, y+1) + getMap(x, y+2)],
                   [[0, -1], (x, y) => getMap(x, y-2) + getMap(x, y-1)],
                   [[1, 0],  (x, y) => getMap(x + 1, y) + getMap(x + 2, y)],
                   [[-1, 0], (x, y) => getMap(x - 2, y) + getMap(x - 1, y)]
                   ];
    map.forEach((row, y) =>
        row.forEach((v, x) => {
            if (v !== '.')
                return;

            moves.forEach(([[dx, dy], getLabelFn]) => {
                if (/[A-Z]/.test(getMap(x + dx, y + dy))) {
                    setLocation(getLabelFn(x, y), [x, y]);
                }
            })
        })
    );

    const width = Math.max(...map.get(2).keys()) + 2; // +2 for optional letters not present in row 3 (corner piece)
    const height = Math.max(...map.keys());

    const isOuterEdge = ([x, y]) => x === 2 || y === 2 || x === width - 2 || y === height - 2;

    locations.forEach((points, id) => {
        if (points.length === 2) {
            jumps.set(posId(points[0]), [points[1], isOuterEdge(points[0]) ? -1 : 1]);
            jumps.set(posId(points[1]), [points[0], isOuterEdge(points[1]) ? -1 : 1]);
        }
    });

    // prettyPicture(map, v => v === '.' ? ' ' : v, ' ');
    return [map, locations, jumps];
}

const solve = maze => {
    const [map, locations, jumps] = createMap(maze);
    const getMap = ([x, y]) => (map.has(y) ? map.get(y) : map.set(y, new Map).get(y)).get(x);

    const dfsShortestPath = (from, toId, level, path = []) => {
        const fromId = posId(from, level);

        if (level < 0 || level > Math.min(jumps.size/2, 25) || path.includes(fromId) || getMap(from) !== '.')
            return Infinity;

        if (fromId === toId) {
            return path.length;
        }

        path.push(fromId);

        const [x, y] = from;
        let moves = [[[x, y + 1], 0], [[x, y - 1], 0], [[x + 1, y], 0], [[x - 1, y], 0]];

        let jumpFromId = posId(from);
        if (jumps.has(jumpFromId))
            moves.push(jumps.get(jumpFromId));

        return Math.min(...moves.map(target => dfsShortestPath(target[0], toId, level + target[1], [...path])));
    }

    return dfsShortestPath(locations.get('AA')[0], posId(locations.get('ZZ')[0]), 0);
}

let test = `             Z L X W       C
             Z P Q B       K
  ###########.#.#.#.#######.###############
  #...#.......#.#.......#.#.......#.#.#...#
  ###.#.#.#.#.#.#.#.###.#.#.#######.#.#.###
  #.#...#.#.#...#.#.#...#...#...#.#.......#
  #.###.#######.###.###.#.###.###.#.#######
  #...#.......#.#...#...#.............#...#
  #.#########.#######.#.#######.#######.###
  #...#.#    F       R I       Z    #.#.#.#
  #.###.#    D       E C       H    #.#.#.#
  #.#...#                           #...#.#
  #.###.#                           #.###.#
  #.#....OA                       WB..#.#..ZH
  #.###.#                           #.#.#.#
CJ......#                           #.....#
  #######                           #######
  #.#....CK                         #......IC
  #.###.#                           #.###.#
  #.....#                           #...#.#
  ###.###                           #.#.#.#
XF....#.#                         RF..#.#.#
  #####.#                           #######
  #......CJ                       NM..#...#
  ###.#.#                           #.###.#
RE....#.#                           #......RF
  ###.###        X   X       L      #.#.#.#
  #.....#        F   Q       P      #.#.#.#
  ###.###########.###.#######.#########.###
  #.....#...#.....#.......#...#.....#.#...#
  #####.#.###.#######.#######.###.###.#.#.#
  #.......#.......#.#.#.#.#...#...#...#.#.#
  #####.###.#####.#.#.#.#.###.###.#.###.###
  #.......#.....#.#...#...............#...#
  #############.#.#.###.###################
               A O F   N
               A A D   M                     `;
console.log(solve(test), 396);


test = `                                           Q     X       I         D     Z         U
                                           E     O       Y         T     B         X
  #########################################.#####.#######.#########.#####.#########.#########################################
  #...#...#.#.........#.#.#...#.#.............#.......#.....#...#.#.....#.....#.#.................#.#.#...#...#.#...#.......#
  #.###.###.###.#####.#.#.###.#.#.#.###.###.#.#######.#.###.#.###.###.###.###.#.#####.#.#####.#.###.#.#.###.###.#.###.###.###
  #.............#.................#.#.....#.#.#.......#...#.#.......#.#.#.#...#.......#.....#.#.#.#.............#.#...#...#.#
  #####.###.###.###.#.###.#.#.#.#.#######.#.#######.#####.#####.###.#.#.###.###.###.#.#.#########.#.#.#.#####.###.#.#######.#
  #.#...#...#...#...#.#...#.#.#.#...#.....#.#.....#.#.#.......#...#...#...#.#.#...#.#.#.............#.#.....#...#.#.....#...#
  #.#######.#####.#.###########.###.###.#######.#.#.#.###.#####.#.#####.#.#.#.###.###.#.#.#.###.#.###.###.#######.#.#######.#
  #.#.#.#...#...#.#.#...........#...#.....#.#...#.....#.....#...#.....#.#.....#.....#.#.#.#...#.#...#.#.....#.........#.#...#
  #.#.#.#######.#.#####.###.#.#####.###.#.#.###.###.#.#.#.#########.#.#.#######.#.#############.#####.#############.###.###.#
  #.#.....#.....#.#.......#.#.#.#.....#.#...#.....#.#.#.#.#.#.#.#.#.#.#.......#.#.#.....#.#...#...#.#...#...#.#.......#.....#
  #.###.#######.#######.#######.#.#####.#########.#######.#.#.#.#.#.#.#####.###.###.#####.#.###.###.#######.#.#####.###.###.#
  #.....#...#.......#.#...#.......#...#.#.#...#.....#.............#.#.....#...#.#...#.....#...#.#.#...........#.#...#.#.#.#.#
  #.###.###.#####.###.#####.#####.###.#.#.#.###.#####.#.#####.#######.#####.###.###.#.###.#.###.#.###.###.#####.###.#.#.#.###
  #.#.#.#.......#...#.#...#...#.#.#.#.......#.......#.#...#.....#.....#.#.....#.........#.#...#...#.....#.#.#...#.........#.#
  ###.#.#####.###.###.#.#######.###.#.###.#####.###.#.#.#.###########.#.#####.###.#.###.###.#####.###.#####.#.#######.#####.#
  #...#.......#...........#.#.#.#...#.#.#.#.#...#.#.#.#.#...#.#.#.#.#.....#...#.#.#...#.#.....#.#.#.#...#.....#.....#.#.#.#.#
  ###.#######.#####.#######.#.#.###.###.#.#.###.#.#####.#####.#.#.#.#.###.###.#.#.#########.###.###.#.#######.###.###.#.#.#.#
  #.....#.#.....#.....#...#...................#...#.....#.........#.....#.#...#.......#.#...#...#.#.....#.#.........#.......#
  #####.#.###.###.#.###.###.#######.###.#########.#####.#.#.###.#####.###.###.#.#######.#.#.#.###.###.#.#.###.#.#.###.#####.#
  #.....#.#.....#.#.......#.#...#.#.#.......#.....#.#.#.#.#.#.#.#.#...#...#...#.....#...#.#.#.#.#.....#...#.#.#.#...#...#.#.#
  #####.#.#####.###.###.#######.#.###.#####.#.#.###.#.#.#.###.###.###.#######.###.#####.#.###.#.#####.#####.#####.#.#.###.###
  #.#.#...#...#...#.#.#.#.#.......#.#.#...#.#.#.#.....#...#.#.....#...#.#...#.#...#...............#.......#.....#.#.....#...#
  #.#.#.#.###.#.#####.#.#.###.#####.#.#.#.#.###.###.#.#.###.###.#.#.###.#.#.#.#.#.#.#.#####.#########.#######.#######.###.###
  #.#...#...#.#...#...#.#.#.....#.....#.#.#...#.....#.#.....#...#.#...#...#...#.#...#...#.#.....#.#...#.#...#.#.........#...#
  #.###.#####.#.#####.#.#.#.#####.#.###.#.###.#######.#.#######.#.###.#.###.#.#.#.###.###.#######.#.###.#.#.#.#########.#.###
  #.#...#...#.....#...#.#...#.#.#.#.#...#.....#.....#.#.......#.#.....#.#.#.#.#.#.#...#.....#.#.....#.#...#.#...#.#.#.#.#.#.#
  #.#.###.###.#.#.#.###.###.#.#.###.###.###.###.#.###.###.###.#.#####.#.#.#########.###.#.###.###.###.#.#####.###.#.#.#.#.#.#
  #.#...#...#.#.#.#.#.#.#.#.....#...#.....#...#.#...#...#.#...#.....#.#.....#.#.#.......#.#...#.#.#.#.#.#.#.#...#.#.........#
  #.#.###.#######.#.#.#.#.#####.#######.###.###.###.#.#######.#####.#.###.###.#.#####.#####.###.#.#.#.#.#.#.#.#.#.#.#.#.#.###
  #...#.....#.#...#...#.....#.....#.#.#...#.#.....#.....#.#.....#.#.#.#.#.#...#...#...........#.#...#.........#.#.#.#.#.#...#
  #.#####.###.###.#.#.#.#######.###.#.#.#.###.###.#.#.###.###.###.#.###.#.#.#####.#.#####.#####.#.#####.###.#####.#####.#####
  #.....#.#.....#.#.#.#.#.#.....#.......#.#...#...#.#...#.....#.........#.....#.........#.#.....#.......#.#.#.....#.#.#.....#
  ###.###.###.###.###.#.#.###.#########.#########.#######.###########.#####.#####.#############.#.###.###.#######.#.#.#####.#
  #.....#.#...#.....#.#.#...#.#.#.#    W         Q       U           D     B     N          #.....#.#.#.......#...#...#...#.#
  ###.###.###.###.###.#.###.#.#.#.#    V         H       J           G     B     F          #####.#.###.#.###.#.###.###.###.#
AA......#.................#...#...#                                                         #.#.......#.#.#.....#.#.......#.#
  ###.###.###.#.#.#.#####.#.#.###.#                                                         #.#####.#########.###.###.#.###.#
  #...#...#.#.#.#.#...#.#.#.#.#....BF                                                       #.....#.....#.#.#...#.#.#.#.#.#.#
  #.#.#.###.#.#########.#.#.#.#.###                                                         #.#.###.#####.#.#.#.#.#.###.#.#.#
  #.#.#...#.....#.#.#...#.#.#.....#                                                       XL..#.....#.#...#.#.#.#.......#....BF
  #.###.###.#.###.#.#.#.#.#.#######                                                         #####.#.#.#.###.###.#.#.###.###.#
UJ........#.#.#.#...#.#.#...#.#.#.#                                                         #.#...#.#.....#.......#.#.....#.#
  #############.#.#####.#####.#.#.#                                                         #.###.#.#.###.###.#.#.###.#####.#
  #.....#.#.#...#.......#.........#                                                         #...#.#.....#.....#.#.#.........#
  #.###.#.#.#.#.#.#####.#.#####.###                                                         ###.###################.#####.###
  #...#.......#...#.........#.....#                                                       XB..#...................#...#.....#
  ###.#####.###.#.###.#.#.#######.#                                                         #.#.#####.#.#.#.#####.#.#####.###
  #.#...#...#...#...#.#.#.#...#...#                                                         #.#.#...#.#.#.#...#...#.....#.#.#
  #.###.###.###.#.#####.###.###.###                                                         #.#.#.#####.###.###.#####.#####.#
JG........#.#.#.#.#...#.#.#...#....DT                                                       #.#...#...#...#...#.#...#.#.#...#
  ###.#######.#######.###.###.#####                                                         #.###.###.#########.#.#.###.#.###
  #.......#...#.#.........#.......#                                                         #.......#.....#.#.#...#..........QS
  #####.###.#.#.#.#.#.###.#.#####.#                                                         #.#######.#####.#.###.###.#######
  #.#.#.#...#.....#.#...#.....#....QS                                                       #...#.............#...#.....#....BB
  #.#.#########.#####.###.#.#.#.#.#                                                         #.###.###.###.###.###.###.###.###
UT..#.......#.#.#.#...#.#.#.#.#.#.#                                                         #.#...#...#.....#...#.#.#.#.#...#
  #.#.#.#####.#.#.#####.###########                                                         #####.#.###.#.#.###.#.#.###.#.###
  #...#...........#...#.#.#.......#                                                       CP..#...#.#.#.#.#.#...#.#.#.#.....#
  #######.#.#.#####.###.#.#####.###                                                         #.###.###.#########.###.#.#.#####
  #.#...#.#.#.#.........#.........#                                                         #.....#...#.......#.........#.#.#
  #.#.###########.#####.#.###.###.#                                                         #########.#######.#######.#.#.#.#
  #.....#...#.#.#.#.#.......#.#.#.#                                                         #.........#.#.#.......#.#.#.#...#
  #.#.###.#.#.#.#.###.#######.#.#.#                                                         #.#######.#.#.#.#.#.#.#.#######.#
QO..#...#.#.#...#...#.....#.#.#...#                                                       QM........#.......#.#.#.........#..XL
  #####.#.#.#.#.###.#.#####.#####.#                                                         #.###.#####.###.#####.#.#.#####.#
  #.#.#...#...#.....#...#.#.#.#.#..QE                                                       #.#...#.#.....#.#.....#.#.....#.#
  #.#.#######.###.#######.#.#.#.#.#                                                         #####.#.###.###.###########.###.#
  #.#.....#.#...#...#.#.#.......#.#                                                         #...#...#...#...#.#.......#.....#
  #.###.#.#.#########.#.#.###.#.###                                                         #.#######.#.###.#.#.#.#.#########
  #.....#...#.#.#...#.#.#.#.#.#...#                                                         #.#...#...#.#...#.#.#.#...#.....#
  #.#####.###.#.#.###.#.###.#.#.###                                                         #.###.#####.#####.#####.#.#.#.###
  #.....#.#.#.....#.....#...#.#.#..DZ                                                       #.#.#...#.#...#.#.#.#...#...#....DG
  #####.#.#.###.#.###.###.#.#.#.#.#                                                         #.#.###.#.#####.#.#.#.#####.#.#.#
XB......#.......#.........#...#...#                                                       MS....#.#.#.....#.#.#.....#.#.#.#.#
  #.#.###.#########################                                                         #.###.#.###.###.#.#.#####.#####.#
  #.#.#.#.#.......................#                                                         #.....................#.#.#...#.#
  ###.#.#######.#########.###.#.#.#                                                         #.#.#.#.###.###.###.###.#.###.###
ZZ..#.#.......#.#.#.....#.#.#.#.#..AF                                                       #.#.#.#...#...#.#.#.#.......#...#
  #.###.###.###.#.#######.#.#.#.#.#                                                         ###########.#####.#####.###.#.#.#
JY......#...#.#.......#...#...#.#.#                                                         #.#...#.#...#...........#.....#.#
  #.#.###.###.#######.#############                                                         #.###.#.###.###########.#######.#
  #.#.#.................#.#.#.#...#                                                       UX..#.#.....#.#.#...#.#.#...#.#....DZ
  #######.###############.#.#.###.#                                                         #.#.#.#######.#.###.#.###.#.#.#.#
  #.....#.#.....................#.#                                                         #...........................#.#.#
  #.#.#.###.#.#.#####.###.###.#.#.#                                                         #.#.#.#####.#.#.###.###.#.#####.#
MS..#.#.....#.#.#.......#...#.#....XO                                                       #.#.#...#...#.#...#.#...#.....#.#
  #.###.#.#.#####.###.#########.#.#                                                         #.#####.#####.###########.###.#.#
  #.#...#.#...#.....#...#.......#.#                                                         #.#.#.....#.#.#.#.#.....#...#.#.#
  #.###.#.#.#.###.###.#######.#####    J         R       J       K   Q   U       Z     I    #.#.#.#.###.#.#.#.#.#####.#.#.###
  #.#...#.#.#...#.#.....#.#.......#    Y         G       G       C   O   T       B     Y    #.#...#.#...............#.#.#...#
  #.#.###.#######.###.###.###.#########.#########.#######.#######.###.###.#######.#####.#########.#.#.#.###.#.###.#.#########
  #.#.#.......#...#...#.#...#.#...#.#.#.#.........#.#.....#...#.....#.......#.#...#.#...........#.#.#.#...#.#...#.#.....#...#
  #######.#######.#.#.#.###.###.###.#.#.###.###.###.#.#####.#.#.#.#######.###.###.#.#.#####.#######.#.#.###.#######.#.#.###.#
  #...........#...#.#.#...#.....#.....#...#.#...#.....#.#.#.#.#.#.#.#.#...#.....#.#.#.....#.#.#.#.#.#.#...#...#.#...#.#.....#
  #.#.#.#.#.#.###.#####.#######.###.#####.#.#######.#.#.#.#.#.###.#.#.###.#.###.#.#.###.#####.#.#.#####.#######.#.###.#.#.#.#
  #.#.#.#.#.#.#.....#.....#.#.............#.#...#.#.#.....#.#.#...#.#...#.#.#...#...#...#...........#.......#...#.#.#.#.#.#.#
  #.#####.#.###.#####.#.###.#.#.#######.###.###.#.#.#.#.###.#.#.###.#.###.#.#.###.#####.###.###########.#.#####.###.#.###.###
  #.#.#...#.#...#.#.#.#.......#...#.......#.......#.#.#.#.#.#.#.......#...#.#...#...#.#.......#.....#.#.#.......#.......#...#
  #.#.#.#.#.###.#.#.#######.#.#######.#.#.#####.#.#.#####.#.#.###.#######.#.###.#.#.#.#.###.#.#####.#.###.###.#####.###.#.#.#
  #.#...#.#...#.#...........#.....#...#.#.#...#.#.#...#...#.#...#.#.......#.#.....#.#.....#.#...#.....#.....#.....#...#.#.#.#
  #.#.###.#.###.#.#.#.#.#.###.###.#####.#.#.#.###.#.###.###.###.#.###.###.#.#########.#############.#######.###.#######.#.###
  #.#...#.#.#...#.#.#.#.#.#.....#.....#.#.#.#.....#.......#.#.#.#.#.#.#...#.#...#.#.......................#...#.....#.#.#.#.#
  #.###.###.#####.###.###.#######.#######.#.###########.###.#.#.#.#.###.#.#.#.#.#.###.#.###.###.###.#.###.#####.#.###.###.#.#
  #.#...#.......#.#.....#...#.#.#.#.#.#.#.#.......#.......#.#.......#.#.#.#...#.....#.#...#...#.#...#...#.#.....#.#...#.....#
  #.#####.###.###.###.#.#####.#.#.#.#.#.#.###.#.#.#.#######.#####.###.###.###.###.#####.###########.#####.#.#####.###.#####.#
  #...#.....#...#.#...#.#.....#.#.#.#.#.#.#.#.#.#.#.#.#.......#.....#.#...#...#.#.#.....#.#.#.#.#.......#.#.#...#.......#...#
  #.#.###.#######.#.#.###.###.#.###.#.#.#.#.#####.#.#.#####.#.#.###.#.#.#.#####.#.###.#.#.#.#.#.###.#####.#.###.#####.#####.#
  #.#.#...#.......#.#.#...#.....#...#.......#.....#.....#...#.#...#...#.#.....#.#.#.#.#.....#.#.#.#.#.#.#.#.#...#.#.......#.#
  #.###.#.#.#####.###.#######.#####.#.###.#.###.#####.#####.#############.#.###.#.#.###.#####.#.#.###.#.#######.#.###########
  #...#.#.#...#...#...#.#.....#.........#.#.#.#.....#.....#...#...#.......#.#...#.#...#...........#.....#...#...........#.#.#
  #.###.###.###########.#####.###.###.#.#####.###.###.###.#.###.#######.#.#####.#.#.###.#.#.#.#####.#####.###.#######.###.#.#
  #.#.#...#.#.#...#.#.#...#.#.......#.#...#.......#.#...#.#.#.....#...#.#.#...........#.#.#.#.........#.#...#.......#.#.#...#
  #.#.#.#####.###.#.#.###.#.#.###.###.###.#####.###.#.#.###.#.#.#####.#.###.#.###.#####.#######.#.###.#.###.#.###.#####.#.#.#
  #...#.#...#...#.#.#...#.....#.#.#...#.......#...#.#.#.#.....#.#.#...#.#.#.#.#.....#.........#.#...#...........#.....#...#.#
  #.#####.#####.#.#.#.###.#.###.#####.#.#######.#.#.#.#.#######.#.#.#.#.#.#.#########.###.#######.#####.#####.#.#.#####.#####
  #.....#.................#.#.....#...#...#.#.#.#.#...#.#.....#...#.#.....#.#...#.#.#...#.......#.....#...#.#.#.#...........#
  #.#####.###.###.#####.###.#####.#.#.###.#.#.###.#.#####.#.#.#.###.###.###.###.#.#.#.###########.#.#######.#####.#.#.###.###
  #.#.#.....#.#...#...#.#.#.#.......#.#.#.#.......#.....#.#.#.#...#...#.#.........#.....#.......#.#.............#.#.#...#...#
  #.#.#.#####.#######.###.#########.###.#.#.#########.#####.#.#.###.#.#####.#####.#.#.#####.#######.###.#.#.#####.#.#.###.###
  #.#.....#.....#...#.#.........#.#.#.#.#.#.....#...#.#.#.#.#.....#.#.#.#.#.#...#.#.#.#.#.......#...#...#.#.....#.#.#...#...#
  #####.#.#.#.###.###.###.#####.#.###.#.#.#.###.#.###.#.#.#.#########.#.#.###.#.#.#.###.#.###.#.#######.#########.#.#.#.#.###
  #.....#.#.#.#...............#...........#...#.....#.....#...#...........#...#...#.......#...#.......#.........#.#.#.#.#...#
  ###################################.#########.#########.###.#####.#.#####.###########.#####################################
                                     N         K         R   C     Q Q     A           W
                                     F         C         G   P     H M     F           V`;

console.log(solve(test))
