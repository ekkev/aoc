const { prettyPicture } = require('./15-2');


const posId = ([x, y]) => x*10000 + y;

const createMap = input => {
    let locations = new Map;
    const jumps = new Map; // posA => posB and posB => posA
    const map = new Map(
            Object.entries(
                input.split('\n')
                    .map(row => new Map(Object.entries(row.split('')).map(([k, v]) => [+k, v])))
                ).map(([k, v]) => [+k, v])
            );

    const getMap = (x, y) => (map.has(y) ? map.get(y) : map.set(y, new Map).get(y)).get(x);
    const setLocation = (id, pos) => { if (!locations.has(id)) { locations.set(id, []) } locations.get(id).push(pos)};

    const moves = [[[0, 1],  (x, y) => getMap(x, y+1) + getMap(x, y+2)],
                   [[0, -1], (x, y) => getMap(x, y-2) + getMap(x, y-1)],
                   [[1, 0],  (x, y) => getMap(x + 1, y) + getMap(x + 2, y)],
                   [[-1, 0], (x, y) => getMap(x - 2, y) + getMap(x - 1, y)]
                   ];
    map.forEach((row, y) =>
        row.forEach((v, x) => {
            if (v !== '.')
                return;

            moves.forEach(([[dx, dy], getLabelFn]) => {
                if (/[A-Z]/.test(getMap(x + dx, y + dy))) {
                    setLocation(getLabelFn(x, y), [x, y]);
                }
            })
        })
    );

    locations.forEach((points, id) => {
        if (points.length === 2) {
            jumps.set(posId(points[0]), points[1]);
            jumps.set(posId(points[1]), points[0]);
        }
    });

    return [map, locations, jumps];
}

const solve = maze => {
    const [map, locations, jumps] = createMap(maze);
    const getMap = ([x, y]) => (map.has(y) ? map.get(y) : map.set(y, new Map).get(y)).get(x);

    const dfsShortestPath = (from, toId, path = []) => {
        const fromId = posId(from);
        if (path.includes(fromId) || getMap(from) !== '.')
            return Infinity;

        if (fromId === toId)
            return path.length;

        path.push(fromId);

        const [x, y] = from;
        let moves = [[x, y + 1], [x, y - 1], [x + 1, y], [x - 1, y]];
        if (jumps.has(fromId))
            moves.push(jumps.get(fromId));

        return Math.min(...moves.map(target => dfsShortestPath(target, toId, [...path])));
    }

    return dfsShortestPath(locations.get('AA')[0], posId(locations.get('ZZ')[0]));
}

let test = `                   A
                   A
  #################.#############
  #.#...#...................#.#.#
  #.#.#.###.###.###.#########.#.#
  #.#.#.......#...#.....#.#.#...#
  #.#########.###.#####.#.#.###.#
  #.............#.#.....#.......#
  ###.###########.###.#####.#.#.#
  #.....#        A   C    #.#.#.#
  #######        S   P    #####.#
  #.#...#                 #......VT
  #.#.#.#                 #.#####
  #...#.#               YN....#.#
  #.###.#                 #####.#
DI....#.#                 #.....#
  #####.#                 #.###.#
ZZ......#               QG....#..AS
  ###.###                 #######
JO..#.#.#                 #.....#
  #.#.#.#                 ###.#.#
  #...#..DI             BU....#..LF
  #####.#                 #.#####
YN......#               VT..#....QG
  #.###.#                 #.###.#
  #.#...#                 #.....#
  ###.###    J L     J    #.#.###
  #.....#    O F     P    #.#...#
  #.###.#####.#.#####.#####.###.#
  #...#.#.#...#.....#.....#.#...#
  #.#####.###.###.#.#.#########.#
  #...#.#.....#...#.#.#.#.....#.#
  #.###.#####.###.###.#.#.#######
  #.#.........#...#.............#
  #########.###.###.#############
           B   J   C
           U   P   P               `;

console.log(solve(test), 58);


test = `                                           Q     X       I         D     Z         U
                                           E     O       Y         T     B         X
  #########################################.#####.#######.#########.#####.#########.#########################################
  #...#...#.#.........#.#.#...#.#.............#.......#.....#...#.#.....#.....#.#.................#.#.#...#...#.#...#.......#
  #.###.###.###.#####.#.#.###.#.#.#.###.###.#.#######.#.###.#.###.###.###.###.#.#####.#.#####.#.###.#.#.###.###.#.###.###.###
  #.............#.................#.#.....#.#.#.......#...#.#.......#.#.#.#...#.......#.....#.#.#.#.............#.#...#...#.#
  #####.###.###.###.#.###.#.#.#.#.#######.#.#######.#####.#####.###.#.#.###.###.###.#.#.#########.#.#.#.#####.###.#.#######.#
  #.#...#...#...#...#.#...#.#.#.#...#.....#.#.....#.#.#.......#...#...#...#.#.#...#.#.#.............#.#.....#...#.#.....#...#
  #.#######.#####.#.###########.###.###.#######.#.#.#.###.#####.#.#####.#.#.#.###.###.#.#.#.###.#.###.###.#######.#.#######.#
  #.#.#.#...#...#.#.#...........#...#.....#.#...#.....#.....#...#.....#.#.....#.....#.#.#.#...#.#...#.#.....#.........#.#...#
  #.#.#.#######.#.#####.###.#.#####.###.#.#.###.###.#.#.#.#########.#.#.#######.#.#############.#####.#############.###.###.#
  #.#.....#.....#.#.......#.#.#.#.....#.#...#.....#.#.#.#.#.#.#.#.#.#.#.......#.#.#.....#.#...#...#.#...#...#.#.......#.....#
  #.###.#######.#######.#######.#.#####.#########.#######.#.#.#.#.#.#.#####.###.###.#####.#.###.###.#######.#.#####.###.###.#
  #.....#...#.......#.#...#.......#...#.#.#...#.....#.............#.#.....#...#.#...#.....#...#.#.#...........#.#...#.#.#.#.#
  #.###.###.#####.###.#####.#####.###.#.#.#.###.#####.#.#####.#######.#####.###.###.#.###.#.###.#.###.###.#####.###.#.#.#.###
  #.#.#.#.......#...#.#...#...#.#.#.#.......#.......#.#...#.....#.....#.#.....#.........#.#...#...#.....#.#.#...#.........#.#
  ###.#.#####.###.###.#.#######.###.#.###.#####.###.#.#.#.###########.#.#####.###.#.###.###.#####.###.#####.#.#######.#####.#
  #...#.......#...........#.#.#.#...#.#.#.#.#...#.#.#.#.#...#.#.#.#.#.....#...#.#.#...#.#.....#.#.#.#...#.....#.....#.#.#.#.#
  ###.#######.#####.#######.#.#.###.###.#.#.###.#.#####.#####.#.#.#.#.###.###.#.#.#########.###.###.#.#######.###.###.#.#.#.#
  #.....#.#.....#.....#...#...................#...#.....#.........#.....#.#...#.......#.#...#...#.#.....#.#.........#.......#
  #####.#.###.###.#.###.###.#######.###.#########.#####.#.#.###.#####.###.###.#.#######.#.#.#.###.###.#.#.###.#.#.###.#####.#
  #.....#.#.....#.#.......#.#...#.#.#.......#.....#.#.#.#.#.#.#.#.#...#...#...#.....#...#.#.#.#.#.....#...#.#.#.#...#...#.#.#
  #####.#.#####.###.###.#######.#.###.#####.#.#.###.#.#.#.###.###.###.#######.###.#####.#.###.#.#####.#####.#####.#.#.###.###
  #.#.#...#...#...#.#.#.#.#.......#.#.#...#.#.#.#.....#...#.#.....#...#.#...#.#...#...............#.......#.....#.#.....#...#
  #.#.#.#.###.#.#####.#.#.###.#####.#.#.#.#.###.###.#.#.###.###.#.#.###.#.#.#.#.#.#.#.#####.#########.#######.#######.###.###
  #.#...#...#.#...#...#.#.#.....#.....#.#.#...#.....#.#.....#...#.#...#...#...#.#...#...#.#.....#.#...#.#...#.#.........#...#
  #.###.#####.#.#####.#.#.#.#####.#.###.#.###.#######.#.#######.#.###.#.###.#.#.#.###.###.#######.#.###.#.#.#.#########.#.###
  #.#...#...#.....#...#.#...#.#.#.#.#...#.....#.....#.#.......#.#.....#.#.#.#.#.#.#...#.....#.#.....#.#...#.#...#.#.#.#.#.#.#
  #.#.###.###.#.#.#.###.###.#.#.###.###.###.###.#.###.###.###.#.#####.#.#.#########.###.#.###.###.###.#.#####.###.#.#.#.#.#.#
  #.#...#...#.#.#.#.#.#.#.#.....#...#.....#...#.#...#...#.#...#.....#.#.....#.#.#.......#.#...#.#.#.#.#.#.#.#...#.#.........#
  #.#.###.#######.#.#.#.#.#####.#######.###.###.###.#.#######.#####.#.###.###.#.#####.#####.###.#.#.#.#.#.#.#.#.#.#.#.#.#.###
  #...#.....#.#...#...#.....#.....#.#.#...#.#.....#.....#.#.....#.#.#.#.#.#...#...#...........#.#...#.........#.#.#.#.#.#...#
  #.#####.###.###.#.#.#.#######.###.#.#.#.###.###.#.#.###.###.###.#.###.#.#.#####.#.#####.#####.#.#####.###.#####.#####.#####
  #.....#.#.....#.#.#.#.#.#.....#.......#.#...#...#.#...#.....#.........#.....#.........#.#.....#.......#.#.#.....#.#.#.....#
  ###.###.###.###.###.#.#.###.#########.#########.#######.###########.#####.#####.#############.#.###.###.#######.#.#.#####.#
  #.....#.#...#.....#.#.#...#.#.#.#    W         Q       U           D     B     N          #.....#.#.#.......#...#...#...#.#
  ###.###.###.###.###.#.###.#.#.#.#    V         H       J           G     B     F          #####.#.###.#.###.#.###.###.###.#
AA......#.................#...#...#                                                         #.#.......#.#.#.....#.#.......#.#
  ###.###.###.#.#.#.#####.#.#.###.#                                                         #.#####.#########.###.###.#.###.#
  #...#...#.#.#.#.#...#.#.#.#.#....BF                                                       #.....#.....#.#.#...#.#.#.#.#.#.#
  #.#.#.###.#.#########.#.#.#.#.###                                                         #.#.###.#####.#.#.#.#.#.###.#.#.#
  #.#.#...#.....#.#.#...#.#.#.....#                                                       XL..#.....#.#...#.#.#.#.......#....BF
  #.###.###.#.###.#.#.#.#.#.#######                                                         #####.#.#.#.###.###.#.#.###.###.#
UJ........#.#.#.#...#.#.#...#.#.#.#                                                         #.#...#.#.....#.......#.#.....#.#
  #############.#.#####.#####.#.#.#                                                         #.###.#.#.###.###.#.#.###.#####.#
  #.....#.#.#...#.......#.........#                                                         #...#.#.....#.....#.#.#.........#
  #.###.#.#.#.#.#.#####.#.#####.###                                                         ###.###################.#####.###
  #...#.......#...#.........#.....#                                                       XB..#...................#...#.....#
  ###.#####.###.#.###.#.#.#######.#                                                         #.#.#####.#.#.#.#####.#.#####.###
  #.#...#...#...#...#.#.#.#...#...#                                                         #.#.#...#.#.#.#...#...#.....#.#.#
  #.###.###.###.#.#####.###.###.###                                                         #.#.#.#####.###.###.#####.#####.#
JG........#.#.#.#.#...#.#.#...#....DT                                                       #.#...#...#...#...#.#...#.#.#...#
  ###.#######.#######.###.###.#####                                                         #.###.###.#########.#.#.###.#.###
  #.......#...#.#.........#.......#                                                         #.......#.....#.#.#...#..........QS
  #####.###.#.#.#.#.#.###.#.#####.#                                                         #.#######.#####.#.###.###.#######
  #.#.#.#...#.....#.#...#.....#....QS                                                       #...#.............#...#.....#....BB
  #.#.#########.#####.###.#.#.#.#.#                                                         #.###.###.###.###.###.###.###.###
UT..#.......#.#.#.#...#.#.#.#.#.#.#                                                         #.#...#...#.....#...#.#.#.#.#...#
  #.#.#.#####.#.#.#####.###########                                                         #####.#.###.#.#.###.#.#.###.#.###
  #...#...........#...#.#.#.......#                                                       CP..#...#.#.#.#.#.#...#.#.#.#.....#
  #######.#.#.#####.###.#.#####.###                                                         #.###.###.#########.###.#.#.#####
  #.#...#.#.#.#.........#.........#                                                         #.....#...#.......#.........#.#.#
  #.#.###########.#####.#.###.###.#                                                         #########.#######.#######.#.#.#.#
  #.....#...#.#.#.#.#.......#.#.#.#                                                         #.........#.#.#.......#.#.#.#...#
  #.#.###.#.#.#.#.###.#######.#.#.#                                                         #.#######.#.#.#.#.#.#.#.#######.#
QO..#...#.#.#...#...#.....#.#.#...#                                                       QM........#.......#.#.#.........#..XL
  #####.#.#.#.#.###.#.#####.#####.#                                                         #.###.#####.###.#####.#.#.#####.#
  #.#.#...#...#.....#...#.#.#.#.#..QE                                                       #.#...#.#.....#.#.....#.#.....#.#
  #.#.#######.###.#######.#.#.#.#.#                                                         #####.#.###.###.###########.###.#
  #.#.....#.#...#...#.#.#.......#.#                                                         #...#...#...#...#.#.......#.....#
  #.###.#.#.#########.#.#.###.#.###                                                         #.#######.#.###.#.#.#.#.#########
  #.....#...#.#.#...#.#.#.#.#.#...#                                                         #.#...#...#.#...#.#.#.#...#.....#
  #.#####.###.#.#.###.#.###.#.#.###                                                         #.###.#####.#####.#####.#.#.#.###
  #.....#.#.#.....#.....#...#.#.#..DZ                                                       #.#.#...#.#...#.#.#.#...#...#....DG
  #####.#.#.###.#.###.###.#.#.#.#.#                                                         #.#.###.#.#####.#.#.#.#####.#.#.#
XB......#.......#.........#...#...#                                                       MS....#.#.#.....#.#.#.....#.#.#.#.#
  #.#.###.#########################                                                         #.###.#.###.###.#.#.#####.#####.#
  #.#.#.#.#.......................#                                                         #.....................#.#.#...#.#
  ###.#.#######.#########.###.#.#.#                                                         #.#.#.#.###.###.###.###.#.###.###
ZZ..#.#.......#.#.#.....#.#.#.#.#..AF                                                       #.#.#.#...#...#.#.#.#.......#...#
  #.###.###.###.#.#######.#.#.#.#.#                                                         ###########.#####.#####.###.#.#.#
JY......#...#.#.......#...#...#.#.#                                                         #.#...#.#...#...........#.....#.#
  #.#.###.###.#######.#############                                                         #.###.#.###.###########.#######.#
  #.#.#.................#.#.#.#...#                                                       UX..#.#.....#.#.#...#.#.#...#.#....DZ
  #######.###############.#.#.###.#                                                         #.#.#.#######.#.###.#.###.#.#.#.#
  #.....#.#.....................#.#                                                         #...........................#.#.#
  #.#.#.###.#.#.#####.###.###.#.#.#                                                         #.#.#.#####.#.#.###.###.#.#####.#
MS..#.#.....#.#.#.......#...#.#....XO                                                       #.#.#...#...#.#...#.#...#.....#.#
  #.###.#.#.#####.###.#########.#.#                                                         #.#####.#####.###########.###.#.#
  #.#...#.#...#.....#...#.......#.#                                                         #.#.#.....#.#.#.#.#.....#...#.#.#
  #.###.#.#.#.###.###.#######.#####    J         R       J       K   Q   U       Z     I    #.#.#.#.###.#.#.#.#.#####.#.#.###
  #.#...#.#.#...#.#.....#.#.......#    Y         G       G       C   O   T       B     Y    #.#...#.#...............#.#.#...#
  #.#.###.#######.###.###.###.#########.#########.#######.#######.###.###.#######.#####.#########.#.#.#.###.#.###.#.#########
  #.#.#.......#...#...#.#...#.#...#.#.#.#.........#.#.....#...#.....#.......#.#...#.#...........#.#.#.#...#.#...#.#.....#...#
  #######.#######.#.#.#.###.###.###.#.#.###.###.###.#.#####.#.#.#.#######.###.###.#.#.#####.#######.#.#.###.#######.#.#.###.#
  #...........#...#.#.#...#.....#.....#...#.#...#.....#.#.#.#.#.#.#.#.#...#.....#.#.#.....#.#.#.#.#.#.#...#...#.#...#.#.....#
  #.#.#.#.#.#.###.#####.#######.###.#####.#.#######.#.#.#.#.#.###.#.#.###.#.###.#.#.###.#####.#.#.#####.#######.#.###.#.#.#.#
  #.#.#.#.#.#.#.....#.....#.#.............#.#...#.#.#.....#.#.#...#.#...#.#.#...#...#...#...........#.......#...#.#.#.#.#.#.#
  #.#####.#.###.#####.#.###.#.#.#######.###.###.#.#.#.#.###.#.#.###.#.###.#.#.###.#####.###.###########.#.#####.###.#.###.###
  #.#.#...#.#...#.#.#.#.......#...#.......#.......#.#.#.#.#.#.#.......#...#.#...#...#.#.......#.....#.#.#.......#.......#...#
  #.#.#.#.#.###.#.#.#######.#.#######.#.#.#####.#.#.#####.#.#.###.#######.#.###.#.#.#.#.###.#.#####.#.###.###.#####.###.#.#.#
  #.#...#.#...#.#...........#.....#...#.#.#...#.#.#...#...#.#...#.#.......#.#.....#.#.....#.#...#.....#.....#.....#...#.#.#.#
  #.#.###.#.###.#.#.#.#.#.###.###.#####.#.#.#.###.#.###.###.###.#.###.###.#.#########.#############.#######.###.#######.#.###
  #.#...#.#.#...#.#.#.#.#.#.....#.....#.#.#.#.....#.......#.#.#.#.#.#.#...#.#...#.#.......................#...#.....#.#.#.#.#
  #.###.###.#####.###.###.#######.#######.#.###########.###.#.#.#.#.###.#.#.#.#.#.###.#.###.###.###.#.###.#####.#.###.###.#.#
  #.#...#.......#.#.....#...#.#.#.#.#.#.#.#.......#.......#.#.......#.#.#.#...#.....#.#...#...#.#...#...#.#.....#.#...#.....#
  #.#####.###.###.###.#.#####.#.#.#.#.#.#.###.#.#.#.#######.#####.###.###.###.###.#####.###########.#####.#.#####.###.#####.#
  #...#.....#...#.#...#.#.....#.#.#.#.#.#.#.#.#.#.#.#.#.......#.....#.#...#...#.#.#.....#.#.#.#.#.......#.#.#...#.......#...#
  #.#.###.#######.#.#.###.###.#.###.#.#.#.#.#####.#.#.#####.#.#.###.#.#.#.#####.#.###.#.#.#.#.#.###.#####.#.###.#####.#####.#
  #.#.#...#.......#.#.#...#.....#...#.......#.....#.....#...#.#...#...#.#.....#.#.#.#.#.....#.#.#.#.#.#.#.#.#...#.#.......#.#
  #.###.#.#.#####.###.#######.#####.#.###.#.###.#####.#####.#############.#.###.#.#.###.#####.#.#.###.#.#######.#.###########
  #...#.#.#...#...#...#.#.....#.........#.#.#.#.....#.....#...#...#.......#.#...#.#...#...........#.....#...#...........#.#.#
  #.###.###.###########.#####.###.###.#.#####.###.###.###.#.###.#######.#.#####.#.#.###.#.#.#.#####.#####.###.#######.###.#.#
  #.#.#...#.#.#...#.#.#...#.#.......#.#...#.......#.#...#.#.#.....#...#.#.#...........#.#.#.#.........#.#...#.......#.#.#...#
  #.#.#.#####.###.#.#.###.#.#.###.###.###.#####.###.#.#.###.#.#.#####.#.###.#.###.#####.#######.#.###.#.###.#.###.#####.#.#.#
  #...#.#...#...#.#.#...#.....#.#.#...#.......#...#.#.#.#.....#.#.#...#.#.#.#.#.....#.........#.#...#...........#.....#...#.#
  #.#####.#####.#.#.#.###.#.###.#####.#.#######.#.#.#.#.#######.#.#.#.#.#.#.#########.###.#######.#####.#####.#.#.#####.#####
  #.....#.................#.#.....#...#...#.#.#.#.#...#.#.....#...#.#.....#.#...#.#.#...#.......#.....#...#.#.#.#...........#
  #.#####.###.###.#####.###.#####.#.#.###.#.#.###.#.#####.#.#.#.###.###.###.###.#.#.#.###########.#.#######.#####.#.#.###.###
  #.#.#.....#.#...#...#.#.#.#.......#.#.#.#.......#.....#.#.#.#...#...#.#.........#.....#.......#.#.............#.#.#...#...#
  #.#.#.#####.#######.###.#########.###.#.#.#########.#####.#.#.###.#.#####.#####.#.#.#####.#######.###.#.#.#####.#.#.###.###
  #.#.....#.....#...#.#.........#.#.#.#.#.#.....#...#.#.#.#.#.....#.#.#.#.#.#...#.#.#.#.#.......#...#...#.#.....#.#.#...#...#
  #####.#.#.#.###.###.###.#####.#.###.#.#.#.###.#.###.#.#.#.#########.#.#.###.#.#.#.###.#.###.#.#######.#########.#.#.#.#.###
  #.....#.#.#.#...............#...........#...#.....#.....#...#...........#...#...#.......#...#.......#.........#.#.#.#.#...#
  ###################################.#########.#########.###.#####.#.#####.###########.#####################################
                                     N         K         R   C     Q Q     A           W
                                     F         C         G   P     H M     F           V`;

console.log(solve(test), 590)
